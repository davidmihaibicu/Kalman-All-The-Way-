-- -------------------------------------------------------------
-- 
-- File Name: hdl_prj\hdlsrc\EkalmanF_ac_sim\Innovation.vhd
-- Created: 2026-01-10 22:56:30
-- 
-- Generated by MATLAB 25.2, HDL Coder 25.2, and Simulink 25.2
-- 
-- -------------------------------------------------------------


-- -------------------------------------------------------------
-- 
-- Module: Innovation
-- Source Path: EkalmanF_ac_sim/EKF/Innovation
-- Hierarchy Level: 1
-- Model version: 1.68
-- 
-- -------------------------------------------------------------
LIBRARY IEEE;
USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;
USE work.EKF_pkg.ALL;

ENTITY Innovation IS
  PORT( x_k_k_1                           :   IN    vector_of_std_logic_vector32(0 TO 3);  -- sfix32_En20 [4]
        z_k                               :   IN    vector_of_std_logic_vector32(0 TO 3);  -- sfix32_En20 [4]
        H                                 :   IN    matrix_of_std_logic_vector32(0 TO 3, 0 TO 3);  -- sfix32_En20 [4x4]
        y_k                               :   OUT   vector_of_std_logic_vector32(0 TO 3)  -- sfix32_En20 [4]
        );
END Innovation;


ARCHITECTURE rtl OF Innovation IS

  -- Constants
  CONSTANT select_indices0_data           : vector_of_signed8(0 TO 15) := 
    (to_signed(16#01#, 8), to_signed(16#05#, 8), to_signed(16#09#, 8), to_signed(16#0D#, 8), to_signed(16#02#, 8),
     to_signed(16#06#, 8), to_signed(16#0A#, 8), to_signed(16#0E#, 8), to_signed(16#03#, 8), to_signed(16#07#, 8),
     to_signed(16#0B#, 8), to_signed(16#0F#, 8), to_signed(16#04#, 8), to_signed(16#08#, 8), to_signed(16#0C#, 8),
     to_signed(16#10#, 8));  -- int8 [16]
  CONSTANT select_indices1_data           : vector_of_signed8(0 TO 15) := 
    (to_signed(16#01#, 8), to_signed(16#02#, 8), to_signed(16#03#, 8), to_signed(16#04#, 8), to_signed(16#01#, 8),
     to_signed(16#02#, 8), to_signed(16#03#, 8), to_signed(16#04#, 8), to_signed(16#01#, 8), to_signed(16#02#, 8),
     to_signed(16#03#, 8), to_signed(16#04#, 8), to_signed(16#01#, 8), to_signed(16#02#, 8), to_signed(16#03#, 8),
     to_signed(16#04#, 8));  -- int8 [16]

  -- Signals
  SIGNAL H_signed                         : matrix_of_signed32(0 TO 3, 0 TO 3);  -- sfix32_En20 [4x4]
  SIGNAL s                                : vector_of_signed32(0 TO 15);  -- sfix32_En20 [16]
  SIGNAL selector_out                     : vector_of_signed32(0 TO 15);  -- sfix32_En20 [16]
  SIGNAL s_1                              : vector_of_signed32(0 TO 15);  -- sfix32_En20 [16]
  SIGNAL x_k_k_1_signed                   : vector_of_signed32(0 TO 3);  -- sfix32_En20 [4]
  SIGNAL selector_out_1                   : vector_of_signed32(0 TO 15);  -- sfix32_En20 [16]
  SIGNAL s_2                              : vector_of_signed32(0 TO 15);  -- sfix32_En20 [16]
  SIGNAL MMul_dot_product_out             : vector_of_signed64(0 TO 15);  -- sfix64_En40 [16]
  SIGNAL reshape_out                      : matrix_of_signed64(0 TO 3, 0 TO 3);  -- sfix64_En40 [4x4]
  SIGNAL selector_out_2                   : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL selector_out_3                   : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL MMul_add_01_out                  : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL selector_out_4                   : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL MMul_add_12_out                  : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL z_k_signed                       : vector_of_signed32(0 TO 3);  -- sfix32_En20 [4]
  SIGNAL selector_out_5                   : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL s_3                              : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL MatrixMultiply_out1              : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL Add_sub_cast                     : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL Add_out1                         : vector_of_signed64(0 TO 3);  -- sfix64_En40 [4]
  SIGNAL Data_Type_Conversion_out1        : vector_of_signed32(0 TO 3);  -- sfix32_En20 [4]

BEGIN
  outputgen3: FOR k IN 0 TO 3 GENERATE
    outputgen4: FOR k1 IN 0 TO 3 GENERATE
      H_signed(k, k1) <= signed(H(k, k1));
    END GENERATE;
  END GENERATE;

  s_gen1: FOR d1 IN 0 TO 3 GENERATE
    s_gen: FOR d0 IN 0 TO 3 GENERATE
      s(d0 + (d1 * 4)) <= H_signed(d0, d1);
    END GENERATE;
  END GENERATE;


  selector_out_gen: FOR ii_select IN 0 TO 15 GENERATE
    selector_out(ii_select) <= s(to_integer(resize(select_indices0_data(ii_select), 32) - 1));
  END GENERATE selector_out_gen;


  s_1_gen: FOR d0 IN 0 TO 15 GENERATE
    s_1(d0) <= selector_out(d0);
  END GENERATE;

  outputgen2: FOR k IN 0 TO 3 GENERATE
    x_k_k_1_signed(k) <= signed(x_k_k_1(k));
  END GENERATE;


  selector_out_1_gen: FOR ii_select1 IN 0 TO 15 GENERATE
    selector_out_1(ii_select1) <= x_k_k_1_signed(to_integer(resize(select_indices1_data(ii_select1), 32) - 1));
  END GENERATE selector_out_1_gen;


  s_2_gen: FOR d0 IN 0 TO 15 GENERATE
    s_2(d0) <= selector_out_1(d0);
  END GENERATE;


  MMul_dot_product_out_gen: FOR t_0 IN 0 TO 15 GENERATE
    MMul_dot_product_out(t_0) <= s_1(t_0) * s_2(t_0);
  END GENERATE MMul_dot_product_out_gen;


  reshape_out_gen1: FOR d1 IN 0 TO 3 GENERATE
    reshape_out_gen: FOR d0 IN 0 TO 3 GENERATE
      reshape_out(d0, d1) <= MMul_dot_product_out(d0 + (d1 * 4));
    END GENERATE;
  END GENERATE;


  selector_out_2_gen: FOR t_01 IN 0 TO 3 GENERATE
    selector_out_2(t_01) <= reshape_out(0, t_01);
  END GENERATE selector_out_2_gen;



  selector_out_3_gen: FOR t_02 IN 0 TO 3 GENERATE
    selector_out_3(t_02) <= reshape_out(1, t_02);
  END GENERATE selector_out_3_gen;



  MMul_add_01_out_gen: FOR t_03 IN 0 TO 3 GENERATE
    MMul_add_01_out(t_03) <= selector_out_2(t_03) + selector_out_3(t_03);
  END GENERATE MMul_add_01_out_gen;



  selector_out_4_gen: FOR t_04 IN 0 TO 3 GENERATE
    selector_out_4(t_04) <= reshape_out(2, t_04);
  END GENERATE selector_out_4_gen;



  MMul_add_12_out_gen: FOR t_05 IN 0 TO 3 GENERATE
    MMul_add_12_out(t_05) <= MMul_add_01_out(t_05) + selector_out_4(t_05);
  END GENERATE MMul_add_12_out_gen;


  outputgen1: FOR k IN 0 TO 3 GENERATE
    z_k_signed(k) <= signed(z_k(k));
  END GENERATE;


  selector_out_5_gen: FOR t_06 IN 0 TO 3 GENERATE
    selector_out_5(t_06) <= reshape_out(3, t_06);
  END GENERATE selector_out_5_gen;



  s_3_gen: FOR t_07 IN 0 TO 3 GENERATE
    s_3(t_07) <= MMul_add_12_out(t_07) + selector_out_5(t_07);
  END GENERATE s_3_gen;


  MatrixMultiply_out1_gen: FOR d0 IN 0 TO 3 GENERATE
    MatrixMultiply_out1(d0) <= s_3(d0);
  END GENERATE;


  Add_out1_gen: FOR t_08 IN 0 TO 3 GENERATE
    Add_sub_cast(t_08) <= resize(z_k_signed(t_08) & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 64);
    Add_out1(t_08) <= Add_sub_cast(t_08) - MatrixMultiply_out1(t_08);
  END GENERATE Add_out1_gen;



  Data_Type_Conversion_out1_gen: FOR ii IN 0 TO 3 GENERATE
    Data_Type_Conversion_out1(ii) <= Add_out1(ii)(51 DOWNTO 20);
  END GENERATE Data_Type_Conversion_out1_gen;


  outputgen: FOR k IN 0 TO 3 GENERATE
    y_k(k) <= std_logic_vector(Data_Type_Conversion_out1(k));
  END GENERATE;

END rtl;

